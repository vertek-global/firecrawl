{"version":3,"file":"search.js","sourceRoot":"","sources":["../../../../src/controllers/v0/search.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response } from \"express\";\nimport {\n  billTeam,\n  checkTeamCredits,\n} from \"../../services/billing/credit_billing\";\nimport { authenticateUser } from \"../auth\";\nimport { RateLimiterMode } from \"../../types\";\nimport { logJob } from \"../../services/logging/log_job\";\nimport { PageOptions, SearchOptions } from \"../../lib/entities\";\nimport { search } from \"../../search\";\nimport { isUrlBlocked } from \"../../scraper/WebScraper/utils/blocklist\";\nimport { v4 as uuidv4 } from \"uuid\";\nimport { logger } from \"../../lib/logger\";\nimport { getScrapeQueue } from \"../../services/queue-service\";\nimport { redisEvictConnection } from \"../../../src/services/redis\";\nimport { addScrapeJob, waitForJob } from \"../../services/queue-jobs\";\nimport * as Sentry from \"@sentry/node\";\nimport { getJobPriority } from \"../../lib/job-priority\";\nimport { Job } from \"bullmq\";\nimport {\n  Document,\n  fromLegacyCombo,\n  fromLegacyScrapeOptions,\n  TeamFlags,\n  toLegacyDocument,\n} from \"../v1/types\";\nimport { getJobFromGCS } from \"../../lib/gcs-jobs\";\n\nexport async function searchHelper(\n  jobId: string,\n  req: Request,\n  team_id: string,\n  subscription_id: string | null | undefined,\n  crawlerOptions: any,\n  pageOptions: PageOptions,\n  searchOptions: SearchOptions,\n  flags: TeamFlags,\n): Promise<{\n  success: boolean;\n  error?: string;\n  data?: any;\n  returnCode: number;\n}> {\n  const query = req.body.query;\n  const advanced = false;\n  if (!query) {\n    return { success: false, error: \"Query is required\", returnCode: 400 };\n  }\n\n  const tbs = searchOptions.tbs ?? undefined;\n  const filter = searchOptions.filter ?? undefined;\n  let num_results = Math.min(searchOptions.limit ?? 7, 10);\n\n  if (team_id === \"d97c4ceb-290b-4957-8432-2b2a02727d95\") {\n    num_results = 1;\n  }\n\n  const num_results_buffer = Math.floor(num_results * 1.5);\n\n  let res = await search({\n    query: query,\n    advanced: advanced,\n    num_results: num_results_buffer,\n    tbs: tbs,\n    filter: filter,\n    lang: searchOptions.lang ?? \"en\",\n    country: searchOptions.country ?? \"us\",\n    location: searchOptions.location,\n  });\n\n  let justSearch = pageOptions.fetchPageContent === false;\n\n  const { scrapeOptions, internalOptions } = fromLegacyCombo(\n    pageOptions,\n    undefined,\n    60000,\n    crawlerOptions,\n    team_id,\n  );\n\n  if (justSearch) {\n    billTeam(team_id, subscription_id, res.length).catch((error) => {\n      logger.error(\n        `Failed to bill team ${team_id} for ${res.length} credits: ${error}`,\n      );\n      // Optionally, you could notify an admin or add to a retry queue here\n    });\n    return { success: true, data: res, returnCode: 200 };\n  }\n\n  res = res.filter((r) => !isUrlBlocked(r.url, flags));\n  if (res.length > num_results) {\n    res = res.slice(0, num_results);\n  }\n\n  if (res.length === 0) {\n    return { success: true, error: \"No search results found\", returnCode: 200 };\n  }\n\n  const jobPriority = await getJobPriority({ team_id, basePriority: 20 });\n\n  // filter out social media links\n\n  const jobDatas = res.map((x) => {\n    const url = x.url;\n    const uuid = uuidv4();\n    return {\n      name: uuid,\n      data: {\n        url,\n        mode: \"single_urls\" as const,\n        team_id: team_id,\n        scrapeOptions,\n        internalOptions,\n        startTime: Date.now(),\n        zeroDataRetention: false, // not supported on v0\n      },\n      opts: {\n        jobId: uuid,\n        priority: jobPriority,\n      },\n    };\n  });\n\n  // TODO: addScrapeJobs\n  for (const job of jobDatas) {\n    await addScrapeJob(job.data, {}, job.opts.jobId, job.opts.priority);\n  }\n\n  const docs = (\n    await Promise.all(\n      jobDatas.map((x) => waitForJob(x.opts.jobId, 60000)),\n    )\n  ).map((x) => toLegacyDocument(x, internalOptions));\n\n  if (docs.length === 0) {\n    return { success: true, error: \"No search results found\", returnCode: 200 };\n  }\n\n  const sq = getScrapeQueue();\n  await Promise.all(jobDatas.map((x) => sq.remove(x.opts.jobId)));\n\n  // make sure doc.content is not empty\n  const filteredDocs = docs.filter(\n    (doc: any) => doc && doc.content && doc.content.trim().length > 0,\n  );\n\n  if (filteredDocs.length === 0) {\n    return {\n      success: true,\n      error: \"No page found\",\n      returnCode: 200,\n      data: docs,\n    };\n  }\n\n  return {\n    success: true,\n    data: filteredDocs,\n    returnCode: 200,\n  };\n}\n\nexport async function searchController(req: Request, res: Response) {\n  try {\n    // make sure to authenticate user first, Bearer <token>\n    const auth = await authenticateUser(req, res, RateLimiterMode.Search);\n    if (!auth.success) {\n      return res.status(auth.status).json({ error: auth.error });\n    }\n    const { team_id, chunk } = auth;\n\n    if (chunk?.flags?.forceZDR) {\n      return res.status(400).json({ error: \"Your team has zero data retention enabled. This is not supported on the v0 API. Please update your code to use the v1 API.\" });\n    }\n\n    redisEvictConnection.sadd(\"teams_using_v0\", team_id)\n      .catch(error => logger.error(\"Failed to add team to teams_using_v0\", { error, team_id }));\n    \n    const crawlerOptions = req.body.crawlerOptions ?? {};\n    const pageOptions = req.body.pageOptions ?? {\n      includeHtml: req.body.pageOptions?.includeHtml ?? false,\n      onlyMainContent: req.body.pageOptions?.onlyMainContent ?? false,\n      fetchPageContent: req.body.pageOptions?.fetchPageContent ?? true,\n      removeTags: req.body.pageOptions?.removeTags ?? [],\n      fallback: req.body.pageOptions?.fallback ?? false,\n    };\n    const origin = req.body.origin ?? \"api\";\n\n    const searchOptions = req.body.searchOptions ?? { limit: 5 };\n\n    const jobId = uuidv4();\n\n    try {\n      const { success: creditsCheckSuccess, message: creditsCheckMessage } =\n        await checkTeamCredits(chunk, team_id, 1);\n      if (!creditsCheckSuccess) {\n        return res.status(402).json({ error: \"Insufficient credits\" });\n      }\n    } catch (error) {\n      Sentry.captureException(error);\n      logger.error(error);\n      return res.status(500).json({ error: \"Internal server error\" });\n    }\n    const startTime = new Date().getTime();\n    const result = await searchHelper(\n      jobId,\n      req,\n      team_id,\n      chunk?.sub_id,\n      crawlerOptions,\n      pageOptions,\n      searchOptions,\n      chunk?.flags ?? null,\n    );\n    const endTime = new Date().getTime();\n    const timeTakenInSeconds = (endTime - startTime) / 1000;\n    logJob({\n      job_id: jobId,\n      success: result.success,\n      message: result.error,\n      num_docs: result.data ? result.data.length : 0,\n      docs: result.data,\n      time_taken: timeTakenInSeconds,\n      team_id: team_id,\n      mode: \"search\",\n      url: req.body.query,\n      scrapeOptions: fromLegacyScrapeOptions(req.body.pageOptions, undefined, 60000, team_id),\n      crawlerOptions: crawlerOptions,\n      origin,\n      integration: req.body.integration,\n      zeroDataRetention: false, // not supported\n    });\n    return res.status(result.returnCode).json(result);\n  } catch (error) {\n    if (\n      error instanceof Error &&\n      (error.message.startsWith(\"Job wait\") || error.message === \"timeout\")\n    ) {\n      return res.status(408).json({ error: \"Request timed out\" });\n    }\n\n    Sentry.captureException(error);\n    logger.error(\"Unhandled error occurred in search\", { error });\n    return res.status(500).json({ error: error.message });\n  }\n}\n"]}