{"version":3,"file":"status.js","sourceRoot":"","sources":["../../../../src/controllers/v0/status.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMA,0EAmDC;AAxDD,oDAAiD;AACjD,8DAAsE;AACtE,iDAAyC;AACzC,qDAAuC;AAEhC,KAAK,UAAU,+BAA+B,CACnD,GAAY,EACZ,GAAa;IAEb,IAAI,CAAC;QACH,MAAM,EAAE,GAAG,MAAM,IAAA,sBAAQ,EAAC,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAC5C,IAAI,CAAC,EAAE,EAAE,CAAC;YACR,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,eAAe,EAAE,CAAC,CAAC;QAC1D,CAAC;QAED,MAAM,MAAM,GAAG,MAAM,IAAA,0BAAY,EAAC,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAEpD,8BAA8B;QAC9B,sDAAsD;QACtD,qEAAqE;QAErE,wBAAwB;QACxB,gCAAgC;QAChC,MAAM;QACN,IAAI;QAEJ,MAAM,IAAI,GAAG,CAAC,MAAM,IAAA,sBAAO,EAAC,GAAG,CAAC,MAAM,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC,CAAC,IAAI,CACzD,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,SAAS,GAAG,CAAC,CAAC,SAAS,CACpC,CAAC;QACF,MAAM,WAAW,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC;QACrE,MAAM,SAAS,GAAG,EAAE,CAAC,SAAS;YAC5B,CAAC,CAAC,QAAQ;YACV,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,KAAK,WAAW,CAAC;gBAC3C,CAAC,CAAC,WAAW;gBACb,CAAC,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,KAAK,QAAQ,CAAC;oBACvC,CAAC,CAAC,QAAQ;oBACV,CAAC,CAAC,QAAQ,CAAC;QAEjB,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAC1B,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,CAChE,CAAC;QAEF,GAAG,CAAC,IAAI,CAAC;YACP,MAAM,EAAE,SAAS;YACjB,OAAO,EAAE,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,KAAK,WAAW,IAAI,CAAC,KAAK,QAAQ,CAAC;iBACpE,MAAM;YACT,KAAK,EAAE,IAAI,CAAC,MAAM;YAClB,IAAI,EAAE,SAAS,KAAK,WAAW,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI;YAC7C,YAAY,EACV,SAAS,KAAK,WAAW,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,KAAK,IAAI,CAAC;SAClE,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,MAAM,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;QAC/B,eAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QACpB,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;IACxD,CAAC;AACH,CAAC","sourcesContent":["import { Request, Response } from \"express\";\nimport { logger } from \"../../../src/lib/logger\";\nimport { getCrawl, getCrawlJobs } from \"../../../src/lib/crawl-redis\";\nimport { getJobs } from \"./crawl-status\";\nimport * as Sentry from \"@sentry/node\";\n\nexport async function crawlJobStatusPreviewController(\n  req: Request,\n  res: Response,\n) {\n  try {\n    const sc = await getCrawl(req.params.jobId);\n    if (!sc) {\n      return res.status(404).json({ error: \"Job not found\" });\n    }\n\n    const jobIDs = await getCrawlJobs(req.params.jobId);\n\n    // let data = job.returnvalue;\n    // if (process.env.USE_DB_AUTHENTICATION === \"true\") {\n    //   const supabaseData = await supabaseGetJobById(req.params.jobId);\n\n    //   if (supabaseData) {\n    //     data = supabaseData.docs;\n    //   }\n    // }\n\n    const jobs = (await getJobs(req.params.jobId, jobIDs)).sort(\n      (a, b) => a.timestamp - b.timestamp,\n    );\n    const jobStatuses = await Promise.all(jobs.map((x) => x.getState()));\n    const jobStatus = sc.cancelled\n      ? \"failed\"\n      : jobStatuses.every((x) => x === \"completed\")\n        ? \"completed\"\n        : jobStatuses.some((x) => x === \"failed\")\n          ? \"failed\"\n          : \"active\";\n\n    const data = jobs.map((x) =>\n      Array.isArray(x.returnvalue) ? x.returnvalue[0] : x.returnvalue,\n    );\n\n    res.json({\n      status: jobStatus,\n      current: jobStatuses.filter((x) => x === \"completed\" || x === \"failed\")\n        .length,\n      total: jobs.length,\n      data: jobStatus === \"completed\" ? data : null,\n      partial_data:\n        jobStatus === \"completed\" ? [] : data.filter((x) => x !== null),\n    });\n  } catch (error) {\n    Sentry.captureException(error);\n    logger.error(error);\n    return res.status(500).json({ error: error.message });\n  }\n}\n"]}