{"version":3,"file":"crawl-status-ws.js","sourceRoot":"","sources":["../../../../src/controllers/v1/crawl-status-ws.ts"],"names":[],"mappings":"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","sourcesContent":["import { authMiddleware } from \"../../routes/v1\";\nimport { RateLimiterMode } from \"../../types\";\nimport { authenticateUser } from \"../auth\";\nimport {\n  CrawlStatusParams,\n  CrawlStatusResponse,\n  Document,\n  ErrorResponse,\n  RequestWithAuth,\n} from \"./types\";\nimport { WebSocket } from \"ws\";\nimport { v4 as uuidv4 } from \"uuid\";\nimport { logger } from \"../../lib/logger\";\nimport {\n  getCrawl,\n  getCrawlExpiry,\n  getCrawlJobs,\n  getDoneJobsOrdered,\n  getDoneJobsOrderedLength,\n  isCrawlFinished,\n  isCrawlFinishedLocked,\n} from \"../../lib/crawl-redis\";\nimport { getScrapeQueue } from \"../../services/queue-service\";\nimport { getJob, getJobs } from \"./crawl-status\";\nimport * as Sentry from \"@sentry/node\";\nimport { Job, JobState } from \"bullmq\";\nimport { getConcurrencyLimitedJobs } from \"../../lib/concurrency-limit\";\n\ntype ErrorMessage = {\n  type: \"error\";\n  error: string;\n};\n\ntype CatchupMessage = {\n  type: \"catchup\";\n  data: CrawlStatusResponse;\n};\n\ntype DocumentMessage = {\n  type: \"document\";\n  data: Document;\n};\n\ntype DoneMessage = { type: \"done\" };\n\ntype Message = ErrorMessage | CatchupMessage | DoneMessage | DocumentMessage;\n\nfunction send(ws: WebSocket, msg: Message) {\n  if (ws.readyState === 1) {\n    return new Promise((resolve, reject) => {\n      ws.send(JSON.stringify(msg), (err) => {\n        if (err) reject(err);\n        else resolve(null);\n      });\n    });\n  }\n}\n\nfunction close(ws: WebSocket, code: number, msg: Message) {\n  if (ws.readyState <= 1) {\n    ws.close(code, JSON.stringify(msg));\n  }\n}\n\nasync function crawlStatusWS(\n  ws: WebSocket,\n  req: RequestWithAuth<CrawlStatusParams, undefined, undefined>,\n) {\n  const sc = await getCrawl(req.params.jobId);\n  if (!sc) {\n    return close(ws, 1008, { type: \"error\", error: \"Job not found\" });\n  }\n\n  if (sc.team_id !== req.auth.team_id) {\n    return close(ws, 3003, { type: \"error\", error: \"Forbidden\" });\n  }\n\n  let doneJobIDs: string[] = [];\n  let finished = false;\n\n  const loop = async () => {\n    if (finished) return;\n\n    const jobIDs = await getCrawlJobs(req.params.jobId);\n\n    if (jobIDs.length === doneJobIDs.length) {\n      return close(ws, 1000, { type: \"done\" });\n    }\n\n    const notDoneJobIDs = jobIDs.filter((x) => !doneJobIDs.includes(x));\n    const jobStatuses = await Promise.all(\n      notDoneJobIDs.map(async (x) => [\n        x,\n        await getScrapeQueue().getJobState(x),\n      ]),\n    );\n    const newlyDoneJobIDs: string[] = jobStatuses\n      .filter((x) => x[1] === \"completed\" || x[1] === \"failed\")\n      .map((x) => x[0]);\n    const newlyDoneJobs: Job[] = (\n      await Promise.all(newlyDoneJobIDs.map((x) => getJob(x)))\n    ).filter((x) => x !== undefined) as Job[];\n\n    for (const job of newlyDoneJobs) {\n      if (job.returnvalue) {\n        send(ws, {\n          type: \"document\",\n          data: job.returnvalue,\n        });\n      } else {\n        // Crawl errors are ignored.\n      }\n    }\n\n    doneJobIDs.push(...newlyDoneJobIDs);\n\n    setTimeout(loop, 1000);\n  };\n\n  setTimeout(loop, 1000);\n\n  doneJobIDs = await getDoneJobsOrdered(req.params.jobId);\n\n  let jobIDs = await getCrawlJobs(req.params.jobId);\n  let jobStatuses = await Promise.all(\n    jobIDs.map(\n      async (x) => [x, await getScrapeQueue().getJobState(x)] as const,\n    ),\n  );\n  const throttledJobsSet = await getConcurrencyLimitedJobs(req.auth.team_id);\n  \n  const validJobStatuses: [string, JobState | \"unknown\"][] = [];\n  const validJobIDs: string[] = [];\n\n  for (const [id, status] of jobStatuses) {\n    if (throttledJobsSet.has(id)) {\n      validJobStatuses.push([id, \"prioritized\"]);\n      validJobIDs.push(id);\n    } else if (\n      status !== \"failed\" &&\n      status !== \"unknown\"\n    ) {\n      validJobStatuses.push([id, status]);\n      validJobIDs.push(id);\n    }\n  }\n\n  const status: Exclude<CrawlStatusResponse, ErrorResponse>[\"status\"] =\n    sc.cancelled\n      ? \"cancelled\"\n      : validJobStatuses.every((x) => x[1] === \"completed\")\n        ? \"completed\"\n        : \"scraping\";\n\n  jobIDs = validJobIDs; // Use validJobIDs instead of jobIDs for further processing\n\n  const doneJobs = await getJobs(doneJobIDs);\n  const data = doneJobs.map((x) => x.returnvalue);\n\n  await send(ws, {\n    type: \"catchup\",\n    data: {\n      success: true,\n      status,\n      total: jobIDs.length,\n      completed: doneJobIDs.length,\n      creditsUsed: jobIDs.length,\n      expiresAt: (await getCrawlExpiry(req.params.jobId)).toISOString(),\n      data: data,\n    },\n  });\n\n  if (status !== \"scraping\") {\n    finished = true;\n    return close(ws, 1000, { type: \"done\" });\n  }\n}\n\n// Basically just middleware and error wrapping\nexport async function crawlStatusWSController(\n  ws: WebSocket,\n  req: RequestWithAuth<CrawlStatusParams, undefined, undefined>,\n) {\n  try {\n    const auth = await authenticateUser(req, null, RateLimiterMode.CrawlStatus);\n\n    if (!auth.success) {\n      return close(ws, 3000, {\n        type: \"error\",\n        error: auth.error,\n      });\n    }\n\n    const { team_id } = auth;\n\n    req.auth = { team_id };\n\n    await crawlStatusWS(ws, req);\n  } catch (err) {\n    Sentry.captureException(err);\n\n    const id = uuidv4();\n    let verbose = JSON.stringify(err);\n    if (verbose === \"{}\") {\n      if (err instanceof Error) {\n        verbose = JSON.stringify({\n          message: err.message,\n          name: err.name,\n          stack: err.stack,\n        });\n      }\n    }\n\n    logger.error(\n      \"Error occurred in WebSocket! (\" +\n        req.path +\n        \") -- ID \" +\n        id +\n        \" -- \" +\n        verbose,\n    );\n    return close(ws, 1011, {\n      type: \"error\",\n      error:\n        \"An unexpected error occurred. Please contact help@firecrawl.com for help. Your exception ID is \" +\n        id,\n    });\n  }\n}\n"]}