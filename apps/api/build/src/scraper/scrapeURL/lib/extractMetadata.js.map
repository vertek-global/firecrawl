{"version":3,"file":"extractMetadata.js","sourceRoot":"","sources":["../../../../../src/scraper/scrapeURL/lib/extractMetadata.ts"],"names":[],"mappings":"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","sourcesContent":["import { load } from \"cheerio\"; // rustified\nimport { Document } from \"../../../controllers/v1/types\";\nimport { Meta } from \"..\";\nimport { extractMetadata as _extractMetadata } from \"../../../lib/html-transformer\";\n\nexport async function extractMetadataRust(\n  meta: Meta,\n  html: string,\n): Promise<Partial<Document[\"metadata\"]>> {\n  const fromRust = await _extractMetadata(html);\n\n  return {\n    ...fromRust,\n    ...(fromRust.favicon ? {\n      favicon: new URL(fromRust.favicon, meta.rewrittenUrl ?? meta.url)\n    } : {}),\n    scrapeId: meta.id,\n  };\n}\n\n\nexport async function extractMetadata(\n  meta: Meta,\n  html: string,\n): Promise<Partial<Document[\"metadata\"]>> {\n  try {\n    return await extractMetadataRust(meta, html);\n  } catch (error) {\n    meta.logger.warn(\"Failed to call html-transformer! Falling back to cheerio...\", {\n      error,\n      module: \"scrapeURL\", method: \"extractMetadata\"\n    });\n  }\n\n  let title: string | undefined = undefined;\n  let description: string | undefined = undefined;\n  let favicon: string | undefined = undefined;\n  let language: string | undefined = undefined;\n  let keywords: string | undefined = undefined;\n  let robots: string | undefined = undefined;\n  let ogTitle: string | undefined = undefined;\n  let ogDescription: string | undefined = undefined;\n  let ogUrl: string | undefined = undefined;\n  let ogImage: string | undefined = undefined;\n  let ogAudio: string | undefined = undefined;\n  let ogDeterminer: string | undefined = undefined;\n  let ogLocale: string | undefined = undefined;\n  let ogLocaleAlternate: string[] | undefined = undefined;\n  let ogSiteName: string | undefined = undefined;\n  let ogVideo: string | undefined = undefined;\n  let dcTermsCreated: string | undefined = undefined;\n  let dcDateCreated: string | undefined = undefined;\n  let dcDate: string | undefined = undefined;\n  let dcTermsType: string | undefined = undefined;\n  let dcType: string | undefined = undefined;\n  let dcTermsAudience: string | undefined = undefined;\n  let dcTermsSubject: string | undefined = undefined;\n  let dcSubject: string | undefined = undefined;\n  let dcDescription: string | undefined = undefined;\n  let dcTermsKeywords: string | undefined = undefined;\n  let modifiedTime: string | undefined = undefined;\n  let publishedTime: string | undefined = undefined;\n  let articleTag: string | undefined = undefined;\n  let articleSection: string | undefined = undefined;\n  const customMetadata: Record<string, string | string[]> = {};\n\n  const soup = load(html);\n\n  try {\n    title = soup(\"title\").first().text().trim() || undefined;\n    description = soup('meta[name=\"description\"]').attr(\"content\") || undefined;\n\n    const faviconLink =\n      soup('link[rel=\"icon\"]').attr(\"href\") ||\n      soup('link[rel*=\"icon\"]').first().attr(\"href\") ||\n      undefined;\n    if (faviconLink) {\n      const baseUrl = new URL(meta.rewrittenUrl ?? meta.url).origin;\n      favicon = faviconLink.startsWith(\"http\")\n        ? faviconLink\n        : `${baseUrl}${faviconLink}`;\n    }\n\n    // Assuming the language is part of the URL as per the regex pattern\n    language = soup(\"html\").attr(\"lang\") || undefined;\n\n    keywords = soup('meta[name=\"keywords\"]').attr(\"content\") || undefined;\n    robots = soup('meta[name=\"robots\"]').attr(\"content\") || undefined;\n    ogTitle = soup('meta[property=\"og:title\"]').attr(\"content\") || undefined;\n    ogDescription =\n      soup('meta[property=\"og:description\"]').attr(\"content\") || undefined;\n    ogUrl = soup('meta[property=\"og:url\"]').attr(\"content\") || undefined;\n    ogImage = soup('meta[property=\"og:image\"]').attr(\"content\") || undefined;\n    ogAudio = soup('meta[property=\"og:audio\"]').attr(\"content\") || undefined;\n    ogDeterminer =\n      soup('meta[property=\"og:determiner\"]').attr(\"content\") || undefined;\n    ogLocale = soup('meta[property=\"og:locale\"]').attr(\"content\") || undefined;\n    ogLocaleAlternate =\n      soup('meta[property=\"og:locale:alternate\"]')\n        .map((i, el) => soup(el).attr(\"content\"))\n        .get() || undefined;\n    ogSiteName =\n      soup('meta[property=\"og:site_name\"]').attr(\"content\") || undefined;\n    ogVideo = soup('meta[property=\"og:video\"]').attr(\"content\") || undefined;\n    articleSection =\n      soup('meta[name=\"article:section\"]').attr(\"content\") || undefined;\n    articleTag = soup('meta[name=\"article:tag\"]').attr(\"content\") || undefined;\n    publishedTime =\n      soup('meta[property=\"article:published_time\"]').attr(\"content\") ||\n      undefined;\n    modifiedTime =\n      soup('meta[property=\"article:modified_time\"]').attr(\"content\") ||\n      undefined;\n    dcTermsKeywords =\n      soup('meta[name=\"dcterms.keywords\"]').attr(\"content\") || undefined;\n    dcDescription =\n      soup('meta[name=\"dc.description\"]').attr(\"content\") || undefined;\n    dcSubject = soup('meta[name=\"dc.subject\"]').attr(\"content\") || undefined;\n    dcTermsSubject =\n      soup('meta[name=\"dcterms.subject\"]').attr(\"content\") || undefined;\n    dcTermsAudience =\n      soup('meta[name=\"dcterms.audience\"]').attr(\"content\") || undefined;\n    dcType = soup('meta[name=\"dc.type\"]').attr(\"content\") || undefined;\n    dcTermsType =\n      soup('meta[name=\"dcterms.type\"]').attr(\"content\") || undefined;\n    dcDate = soup('meta[name=\"dc.date\"]').attr(\"content\") || undefined;\n    dcDateCreated =\n      soup('meta[name=\"dc.date.created\"]').attr(\"content\") || undefined;\n    dcTermsCreated =\n      soup('meta[name=\"dcterms.created\"]').attr(\"content\") || undefined;\n\n    try {\n      // Extract all meta tags for custom metadata\n      soup(\"meta\").each((i, elem) => {\n        try {\n          const name = soup(elem).attr(\"name\") || soup(elem).attr(\"property\") || soup(elem).attr(\"itemprop\");\n          const content = soup(elem).attr(\"content\");\n\n          if (name && content) {\n            if (name === \"description\") {\n              if (customMetadata[name] === undefined) {\n                customMetadata[name] = content;\n              } else {\n                customMetadata[name] = Array.isArray(customMetadata[name]) \n                  ? [...customMetadata[name] as string[], content].join(\", \") \n                  : `${customMetadata[name]}, ${content}`;\n              }\n            } else {\n              if (customMetadata[name] === undefined) {\n                customMetadata[name] = content;\n              } else if (Array.isArray(customMetadata[name])) {\n                (customMetadata[name] as string[]).push(content);\n              } else {\n                customMetadata[name] = [customMetadata[name] as string, content];\n              }\n            }\n          }\n        } catch (error) {\n          meta.logger.error(`Error extracting custom metadata (in)`, { error });\n        }\n      });\n    } catch (error) {\n      meta.logger.error(`Error extracting custom metadata`, { error });\n    }\n  } catch (error) {\n    meta.logger.error(`Error extracting metadata`, { error });\n  }\n\n  return {\n    title,\n    description,\n    favicon,\n    language,\n    keywords,\n    robots,\n    ogTitle,\n    ogDescription,\n    ogUrl,\n    ogImage,\n    ogAudio,\n    ogDeterminer,\n    ogLocale,\n    ogLocaleAlternate,\n    ogSiteName,\n    ogVideo,\n    dcTermsCreated,\n    dcDateCreated,\n    dcDate,\n    dcTermsType,\n    dcType,\n    dcTermsAudience,\n    dcTermsSubject,\n    dcSubject,\n    dcDescription,\n    dcTermsKeywords,\n    modifiedTime,\n    publishedTime,\n    articleTag,\n    articleSection,\n    scrapeId: meta.id,\n    ...customMetadata,\n  };\n}\n"]}