{"version":3,"file":"checkStatus.js","sourceRoot":"","sources":["../../../../../../src/scraper/scrapeURL/engines/fire-engine/checkStatus.ts"],"names":[],"mappings":"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","sourcesContent":["import { Logger } from \"winston\";\nimport * as Sentry from \"@sentry/node\";\nimport { z } from \"zod\";\n\nimport { robustFetch } from \"../../lib/fetch\";\nimport {\n  ActionError,\n  EngineError,\n  SiteError,\n  SSLError,\n  UnsupportedFileError,\n  DNSResolutionError,\n  FEPageLoadFailed\n} from \"../../error\";\nimport { MockState } from \"../../lib/mock\";\nimport { fireEngineURL } from \"./scrape\";\nimport { getDocFromGCS } from \"../../../../lib/gcs-jobs\";\nimport { Meta } from \"../..\";\n\nconst successSchema = z.object({\n  jobId: z.string(),\n  state: z.literal(\"completed\"),\n  processing: z.literal(false),\n\n  // timeTaken: z.number(),\n  content: z.string(),\n  url: z.string().optional(),\n\n  pageStatusCode: z.number(),\n  pageError: z.string().optional(),\n\n  // TODO: this needs to be non-optional, might need fixes on f-e side to ensure reliability\n  responseHeaders: z.record(z.string(), z.string()).optional(),\n\n  // timeTakenCookie: z.number().optional(),\n  // timeTakenRequest: z.number().optional(),\n\n  // legacy: playwright only\n  screenshot: z.string().optional(),\n\n  // new: actions\n  screenshots: z.string().array().optional(),\n  actionContent: z\n    .object({\n      url: z.string(),\n      html: z.string(),\n    })\n    .array()\n    .optional(),\n  actionResults: z.union([\n    z.object({\n      idx: z.number(),\n      type: z.literal(\"screenshot\"),\n      result: z.object({\n        path: z.string(),\n      }),\n    }),\n    z.object({\n      idx: z.number(),\n      type: z.literal(\"scrape\"),\n      result: z.union([\n        z.object({\n          url: z.string(),\n          html: z.string(),\n        }),\n        z.object({\n          url: z.string(),\n          accessibility: z.string(),\n        }),\n      ]),\n    }),\n    z.object({\n      idx: z.number(),\n      type: z.literal(\"executeJavascript\"),\n      result: z.object({\n        return: z.string(),\n      }),\n    }),\n    z.object({\n      idx: z.number(),\n      type: z.literal(\"pdf\"),\n      result: z.object({\n        link: z.string(),\n      }),\n    }),\n  ]).array().optional(),\n\n  // chrome-cdp only -- file download handler\n  file: z\n    .object({\n      name: z.string(),\n      content: z.string(),\n    })\n    .optional()\n    .or(z.null()),\n\n  docUrl: z.string().optional(),\n\n  usedMobileProxy: z.boolean().optional(),\n});\n\nexport type FireEngineCheckStatusSuccess = z.infer<typeof successSchema>;\n\nconst processingSchema = z.object({\n  jobId: z.string(),\n  state: z.enum([\n    \"delayed\",\n    \"active\",\n    \"waiting\",\n    \"waiting-children\",\n    \"unknown\",\n    \"prioritized\",\n  ]),\n  processing: z.boolean(),\n});\n\nconst failedSchema = z.object({\n  jobId: z.string(),\n  state: z.literal(\"failed\"),\n  processing: z.literal(false),\n  error: z.string(),\n});\n\nexport class StillProcessingError extends Error {\n  constructor(jobId: string) {\n    super(\"Job is still under processing\", { cause: { jobId } });\n  }\n}\n\nexport async function fireEngineCheckStatus(\n  meta: Meta,\n  logger: Logger,\n  jobId: string,\n  mock: MockState | null,\n  abort?: AbortSignal,\n): Promise<FireEngineCheckStatusSuccess> {\n  let status = await Sentry.startSpan(\n    {\n      name: \"fire-engine: Check status\",\n      attributes: {\n        jobId,\n      },\n    },\n    async (span) => {\n      return await robustFetch({\n        url: `${fireEngineURL}/scrape/${jobId}`,\n        method: \"GET\",\n        logger: logger.child({ method: \"fireEngineCheckStatus/robustFetch\" }),\n        headers: {\n          ...(Sentry.isInitialized()\n            ? {\n                \"sentry-trace\": Sentry.spanToTraceHeader(span),\n                baggage: Sentry.spanToBaggageHeader(span),\n              }\n            : {}),\n        },\n        mock,\n        abort,\n      });\n    },\n  );\n\n  // Fire-engine now saves the content to GCS\n  if (!status.content && status.docUrl) {\n    const doc = await getDocFromGCS(status.docUrl.split('/').pop() ?? \"\");\n    if (doc) {\n      status = { ...status, ...doc };\n      delete status.docUrl;\n    }\n  }\n\n  const successParse = successSchema.safeParse(status);\n  const processingParse = processingSchema.safeParse(status);\n  const failedParse = failedSchema.safeParse(status);\n\n  if (successParse.success) {\n    logger.debug(\"Scrape succeeded!\", { jobId });\n    return successParse.data;\n  } else if (processingParse.success) {\n    throw new StillProcessingError(jobId);\n  } else if (failedParse.success) {\n    logger.debug(\"Scrape job failed\", { status, jobId });\n    if (\n      typeof status.error === \"string\" &&\n      status.error.includes(\"Chrome error: \")\n    ) {\n      const code = status.error.split(\"Chrome error: \")[1];\n\n      if (code.includes(\"ERR_CERT_\") || code.includes(\"ERR_SSL_\") || code.includes(\"ERR_BAD_SSL_\")) {\n        throw new SSLError(meta.options.skipTlsVerification);\n      } else {\n        throw new SiteError(code);\n      }\n    } else if (\n      typeof status.error === \"string\" &&\n      status.error.includes(\"Dns resolution error for hostname: \")\n    ) {\n      throw new DNSResolutionError(status.error.split(\"Dns resolution error for hostname: \")[1]);\n    } else if (\n      typeof status.error === \"string\" &&\n      status.error.includes(\"File size exceeds\")\n    ) {\n      throw new UnsupportedFileError(\n        \"File size exceeds \" + status.error.split(\"File size exceeds \")[1],\n      );\n    } else if (\n      typeof status.error === \"string\" &&\n      status.error.includes(\"failed to finish without timing out\")\n    ) {\n      logger.warn(\"CDP timed out while loading the page\", { status, jobId });\n      throw new FEPageLoadFailed();\n    } else if (\n      typeof status.error === \"string\" &&\n      // TODO: improve this later\n      (status.error.includes(\"Element\") || status.error.includes(\"Javascript execution failed\"))\n    ) {\n      throw new ActionError(status.error.split(\"Error: \")[1]);\n    } else {\n      throw new EngineError(\"Scrape job failed\", {\n        cause: {\n          status,\n          jobId,\n        },\n      });\n    }\n  } else {\n    logger.debug(\"Check status returned response not matched by any schema\", {\n      status,\n      jobId,\n    });\n    throw new Error(\n      \"Check status returned response not matched by any schema\",\n      {\n        cause: {\n          status,\n          jobId,\n        },\n      },\n    );\n  }\n}\n"]}