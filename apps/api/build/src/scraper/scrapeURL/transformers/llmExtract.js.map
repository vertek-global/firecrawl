{"version":3,"file":"llmExtract.js","sourceRoot":"","sources":["../../../../../src/scraper/scrapeURL/transformers/llmExtract.ts"],"names":[],"mappings":"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","sourcesContent":["import { encoding_for_model } from \"@dqbd/tiktoken\";\nimport { TiktokenModel } from \"@dqbd/tiktoken\";\nimport {\n  Document,\n  ExtractOptions,\n  isAgentExtractModelValid,\n  TokenUsage,\n} from \"../../../controllers/v1/types\";\nimport { Logger } from \"winston\";\nimport { EngineResultsTracker, Meta } from \"..\";\nimport { logger } from \"../../../lib/logger\";\nimport { modelPrices } from \"../../../lib/extract/usage/model-prices\";\nimport {\n  AISDKError,\n  generateObject,\n  generateText,\n  LanguageModel,\n  NoObjectGeneratedError,\n} from \"ai\";\nimport { jsonSchema } from \"ai\";\nimport { getModel } from \"../../../lib/generic-ai\";\nimport { z } from \"zod\";\nimport fs from \"fs/promises\";\nimport Ajv from \"ajv\";\nimport { extractData } from \"../lib/extractSmartScrape\";\nimport { CostTracking } from \"../../../lib/extract/extraction-service\";\n// TODO: fix this, it's horrible\ntype LanguageModelV1ProviderMetadata = {\n  anthropic?: {\n    thinking?: {\n      type: \"enabled\" | \"disabled\";\n      budgetTokens?: number;\n    };\n    tool_choice?: \"auto\" | \"none\" | \"required\";\n  };\n};\n\n// Get max tokens from model prices\nconst getModelLimits = (model: string) => {\n  const modelConfig = modelPrices[model];\n  if (!modelConfig) {\n    // Default fallback values\n    return {\n      maxInputTokens: 8192,\n      maxOutputTokens: 4096,\n      maxTokens: 12288,\n    };\n  }\n  return {\n    maxInputTokens: modelConfig.max_input_tokens || modelConfig.max_tokens,\n    maxOutputTokens: modelConfig.max_output_tokens || modelConfig.max_tokens,\n    maxTokens: modelConfig.max_tokens,\n  };\n};\n\nexport class LLMRefusalError extends Error {\n  public refusal: string;\n  public results: EngineResultsTracker | undefined;\n\n  constructor(refusal: string) {\n    super(\"LLM refused to extract the website's content\");\n    this.refusal = refusal;\n  }\n}\n\nfunction normalizeSchema(x: any): any {\n  if (typeof x !== \"object\" || x === null) return x;\n\n  if (x[\"$defs\"] !== null && typeof x[\"$defs\"] === \"object\") {\n    x[\"$defs\"] = Object.fromEntries(\n      Object.entries(x[\"$defs\"]).map(([name, schema]) => [\n        name,\n        normalizeSchema(schema),\n      ]),\n    );\n  }\n\n  if (x && x.anyOf) {\n    x.anyOf = x.anyOf.map((x) => normalizeSchema(x));\n  }\n\n  if (x && x.oneOf) {\n    x.oneOf = x.oneOf.map((x) => normalizeSchema(x));\n  }\n\n  if (x && x.allOf) {\n    x.allOf = x.allOf.map((x) => normalizeSchema(x));\n  }\n\n  if (x && x.not) {\n    x.not = normalizeSchema(x.not);\n  }\n\n  if (x && x.type === \"object\") {\n    return {\n      ...x,\n      properties: Object.fromEntries(\n        Object.entries(x.properties || {}).map(([k, v]) => [\n          k,\n          normalizeSchema(v),\n        ]),\n      ),\n      required: Object.keys(x.properties || {}),\n      additionalProperties: false,\n    };\n  } else if (x && x.type === \"array\") {\n    return {\n      ...x,\n      items: normalizeSchema(x.items),\n    };\n  } else {\n    return x;\n  }\n}\n\ninterface TrimResult {\n  text: string;\n  numTokens: number;\n  warning?: string;\n}\n\nexport function trimToTokenLimit(\n  text: string,\n  maxTokens: number,\n  modelId: string = \"gpt-4o\",\n  previousWarning?: string,\n): TrimResult {\n  try {\n    const encoder = encoding_for_model(modelId as TiktokenModel);\n    try {\n      const tokens = encoder.encode(text);\n      const numTokens = tokens.length;\n\n      if (numTokens <= maxTokens) {\n        return { text, numTokens };\n      }\n\n      const modifier = 3;\n      // Start with 3 chars per token estimation\n      let currentText = text.slice(0, Math.floor(maxTokens * modifier) - 1);\n\n      // Keep trimming until we're under the token limit\n      while (true) {\n        const currentTokens = encoder.encode(currentText);\n        if (currentTokens.length <= maxTokens) {\n          const warning = `The extraction content would have used more tokens (${numTokens}) than the maximum we allow (${maxTokens}). -- the input has been automatically trimmed.`;\n          return {\n            text: currentText,\n            numTokens: currentTokens.length,\n            warning: previousWarning\n              ? `${warning} ${previousWarning}`\n              : warning,\n          };\n        }\n        const overflow = currentTokens.length * modifier - maxTokens - 1;\n        // If still over limit, remove another chunk\n        currentText = currentText.slice(\n          0,\n          Math.floor(currentText.length - overflow),\n        );\n      }\n    } catch (e) {\n      throw e;\n    } finally {\n      encoder.free();\n    }\n  } catch (error) {\n    // Fallback to a more conservative character-based approach\n    const estimatedCharsPerToken = 2.8;\n    const safeLength = maxTokens * estimatedCharsPerToken;\n    const trimmedText = text.slice(0, Math.floor(safeLength));\n\n    const warning = `Failed to derive number of LLM tokens the extraction might use -- the input has been automatically trimmed to the maximum number of tokens (${maxTokens}) we support.`;\n\n    return {\n      text: trimmedText,\n      numTokens: maxTokens, // We assume we hit the max in this fallback case\n      warning: previousWarning ? `${warning} ${previousWarning}` : warning,\n    };\n  }\n}\n\nexport function calculateCost(\n  model: string,\n  inputTokens: number,\n  outputTokens: number,\n) {\n  const modelCosts = {\n    \"openai/o3-mini\": { input_cost: 1.1, output_cost: 4.4 },\n    \"gpt-4o-mini\": { input_cost: 0.15, output_cost: 0.6 },\n    \"openai/gpt-4o-mini\": { input_cost: 0.15, output_cost: 0.6 },\n    \"openai/gpt-4o\": { input_cost: 2.5, output_cost: 10 },\n    \"google/gemini-2.0-flash-001\": { input_cost: 0.15, output_cost: 0.6 },\n    \"deepseek/deepseek-r1\": { input_cost: 0.55, output_cost: 2.19 },\n    \"google/gemini-2.0-flash-thinking-exp:free\": {\n      input_cost: 0.55,\n      output_cost: 2.19,\n    },\n  };\n  let modelCost = modelCosts[model] || { input_cost: 0, output_cost: 0 };\n  //gemini-2.5-pro-exp-03-25 pricing\n  if (\n    model.includes(\"gemini-2.5-pro\")\n  ) {\n    let inputCost = 0;\n    let outputCost = 0;\n    if (inputTokens <= 200000) {\n      inputCost = 1.25;\n      outputCost = 10.0;\n    } else {\n      inputCost = 2.5;\n      outputCost = 15.0;\n    }\n    modelCost = { input_cost: inputCost, output_cost: outputCost };\n  }\n  const totalCost =\n    (inputTokens * modelCost.input_cost +\n      outputTokens * modelCost.output_cost) /\n    1_000_000;\n\n  return totalCost;\n}\n\nexport type GenerateCompletionsOptions = {\n  model?: LanguageModel;\n  logger: Logger;\n  options: ExtractOptions;\n  markdown?: string;\n  previousWarning?: string;\n  isExtractEndpoint?: boolean;\n  mode?: \"object\" | \"no-object\";\n  providerOptions?: LanguageModelV1ProviderMetadata;\n  retryModel?: LanguageModel;\n  costTrackingOptions: {\n    costTracking: CostTracking;\n    metadata: Record<string, any>;\n  };\n};\nexport async function generateCompletions({\n  logger,\n  options,\n  markdown,\n  previousWarning,\n  isExtractEndpoint,\n  model = getModel(\"gpt-4o-mini\", \"openai\"),\n  mode = \"object\",\n  providerOptions,\n  retryModel = getModel(\"claude-3-5-sonnet-20240620\", \"anthropic\"),\n  costTrackingOptions,\n}: GenerateCompletionsOptions): Promise<{\n  extract: any;\n  numTokens: number;\n  warning: string | undefined;\n  totalUsage: TokenUsage;\n  model: string;\n}> {\n  let extract: any;\n  let warning: string | undefined;\n  let currentModel = model;\n  let lastError: Error | null = null;\n\n  if (markdown === undefined) {\n    throw new Error(\"document.markdown is undefined -- this is unexpected\");\n  }\n\n  try {\n    const prompt =\n      options.prompt !== undefined\n        ? `Transform the following content into structured JSON output based on the provided schema and this user request: ${options.prompt}. If schema is provided, strictly follow it.\\n\\n${markdown}`\n        : `Transform the following content into structured JSON output based on the provided schema if any.\\n\\n${markdown}`;\n\n    if (mode === \"no-object\") {\n      try {\n        const result = await generateText({\n          model: currentModel,\n          prompt: options.prompt + (markdown ? `\\n\\nData:${markdown}` : \"\"),\n          system: options.systemPrompt,\n          providerOptions: {\n            anthropic: {\n              thinking: { type: \"enabled\", budgetTokens: 12000 },\n            },\n          },\n        });\n\n        costTrackingOptions.costTracking.addCall({\n          type: \"other\",\n          metadata: {\n            ...costTrackingOptions.metadata,\n            gcDetails: \"no-object\",\n          },\n          model: currentModel.modelId,\n          cost: calculateCost(\n            currentModel.modelId,\n            result.usage?.promptTokens ?? 0,\n            result.usage?.completionTokens ?? 0,\n          ),\n          tokens: {\n            input: result.usage?.promptTokens ?? 0,\n            output: result.usage?.completionTokens ?? 0,\n          }\n        });\n\n        extract = result.text;\n\n        return {\n          extract,\n          warning,\n          numTokens: result.usage?.promptTokens ?? 0,\n          totalUsage: {\n            promptTokens: result.usage?.promptTokens ?? 0,\n            completionTokens: result.usage?.completionTokens ?? 0,\n            totalTokens: result.usage?.promptTokens ?? 0 + (result.usage?.completionTokens ?? 0),\n          },\n          model: currentModel.modelId,\n        };\n      } catch (error) {\n        lastError = error as Error;\n        if (\n          error.message?.includes(\"Quota exceeded\") ||\n          error.message?.includes(\"You exceeded your current quota\") ||\n          error.message?.includes(\"rate limit\")\n        ) {\n          logger.warn(\"Quota exceeded, retrying with fallback model\", {\n            error: lastError.message,\n          });\n          currentModel = retryModel;\n          try {\n            const result = await generateText({\n              model: currentModel,\n              prompt: options.prompt + (markdown ? `\\n\\nData:${markdown}` : \"\"),\n              system: options.systemPrompt,\n              providerOptions: {\n                anthropic: {\n                  thinking: { type: \"enabled\", budgetTokens: 12000 },\n                },\n              },\n            });\n\n            extract = result.text;\n\n            costTrackingOptions.costTracking.addCall({\n              type: \"other\",\n              metadata: {\n                ...costTrackingOptions.metadata,\n                gcDetails: \"no-object fallback\",\n              },\n              model: currentModel.modelId,\n              cost: calculateCost(\n                currentModel.modelId,\n                result.usage?.promptTokens ?? 0,\n                result.usage?.completionTokens ?? 0,\n              ),\n              tokens: {\n                input: result.usage?.promptTokens ?? 0,\n                output: result.usage?.completionTokens ?? 0,\n              }\n            });\n\n            return {\n              extract,\n              warning,\n              numTokens: result.usage?.promptTokens ?? 0,\n              totalUsage: {\n                promptTokens: result.usage?.promptTokens ?? 0,\n                completionTokens: result.usage?.completionTokens ?? 0,\n                totalTokens: result.usage?.promptTokens ?? 0 + (result.usage?.completionTokens ?? 0),\n              },\n              model: currentModel.modelId,\n            };\n          } catch (retryError) {\n            lastError = retryError as Error;\n            logger.error(\"Failed with fallback model\", {\n              originalError: lastError.message,\n              model: currentModel.modelId,\n            });\n            throw lastError;\n          }\n        }\n        throw lastError;\n      }\n    }\n\n    let schema = options.schema;\n    // Normalize the bad json schema users write (mogery)\n    if (schema && !(schema instanceof z.ZodType)) {\n      // let schema = options.schema;\n      if (schema) {\n        schema = removeDefaultProperty(schema);\n      }\n\n      if (schema && schema.type === \"array\") {\n        schema = {\n          type: \"object\",\n          properties: {\n            items: options.schema,\n          },\n          required: [\"items\"],\n          additionalProperties: false,\n        };\n      } else if (schema && typeof schema === \"object\" && !schema.type) {\n        schema = {\n          type: \"object\",\n          properties: Object.fromEntries(\n            Object.entries(schema).map(([key, value]) => {\n              return [key, removeDefaultProperty(value)];\n            }),\n          ),\n          required: Object.keys(schema),\n          additionalProperties: false,\n        };\n      }\n\n      schema = normalizeSchema(schema);\n    }\n\n    const repairConfig = {\n      experimental_repairText: async ({ text, error }) => {\n        // AI may output a markdown JSON code block. Remove it - mogery\n        logger.debug(\"Repairing text\", { textType: typeof text, textPeek: JSON.stringify(text).slice(0, 100) + \"...\", error });\n\n        if (typeof text === \"string\" && text.trim().startsWith(\"```\")) {\n          if (text.trim().startsWith(\"```json\")) {\n            text = text.trim().slice(\"```json\".length).trim();\n          } else {\n            text = text.trim().slice(\"```\".length).trim();\n          }\n\n          if (text.trim().endsWith(\"```\")) {\n            text = text.trim().slice(0, -\"```\".length).trim();\n          }\n\n          // If this fixes the JSON, just return it. If not, continue - mogery\n          try {\n            JSON.parse(text);\n            logger.debug(\"Repaired text with string manipulation\");\n            return text;\n          } catch (e) {\n            logger.error(\"Even after repairing, failed to parse JSON\", { error: e });\n          }\n        }\n\n        try {\n          const { text: fixedText, usage: repairUsage } = await generateText({\n            model: currentModel,\n            prompt: `Fix this JSON that had the following error: ${error}\\n\\nOriginal text:\\n${text}\\n\\nReturn only the fixed JSON, no explanation.`,\n            system:\n              \"You are a JSON repair expert. Your only job is to fix malformed JSON and return valid JSON that matches the original structure and intent as closely as possible. Do not include any explanation or commentary - only return the fixed JSON. Do not return it in a Markdown code block, just plain JSON.\",\n            providerOptions: {\n              anthropic: {\n                thinking: { type: \"enabled\", budgetTokens: 12000 },\n              },\n            },\n          });\n\n          costTrackingOptions.costTracking.addCall({\n            type: \"other\",\n            metadata: {\n              ...costTrackingOptions.metadata,\n              gcDetails: \"repairConfig\",\n            },\n            cost: calculateCost(\n              currentModel.modelId,\n              repairUsage?.promptTokens ?? 0,\n              repairUsage?.completionTokens ?? 0,\n            ),\n            model: currentModel.modelId,\n            tokens: {\n              input: repairUsage?.promptTokens ?? 0,\n              output: repairUsage?.completionTokens ?? 0,\n            },\n          });\n          logger.debug(\"Repaired text with LLM\");\n          return fixedText;\n        } catch (repairError) {\n          lastError = repairError as Error;\n          logger.error(\"Failed to repair JSON\", { error: lastError.message });\n          throw lastError;\n        }\n      },\n    };\n\n    const generateObjectConfig = {\n      model: currentModel,\n      prompt: prompt,\n      providerOptions: providerOptions || undefined,\n      system: options.systemPrompt,\n      ...(schema && {\n        schema: schema instanceof z.ZodType ? schema : jsonSchema(schema),\n      }),\n      ...(!schema && { output: \"no-schema\" as const }),\n      ...repairConfig,\n      ...(!schema && {\n        onError: (error: Error) => {\n          lastError = error;\n          console.error(error);\n        },\n      }),\n    } satisfies Parameters<typeof generateObject>[0];\n\n    // const now = new Date().getTime();\n    // await fs.writeFile(\n    //   `logs/generateObjectConfig-${now}.json`,\n    //   JSON.stringify(generateObjectConfig, null, 2),\n    // );\n\n    logger.debug(\"Generating object...\", { generateObjectConfig: {\n      ...generateObjectConfig,\n      prompt: generateObjectConfig.prompt.slice(0, 100) + \"...\",\n      system: generateObjectConfig.system?.slice(0, 100) + \"...\",\n    }, model, retryModel });\n\n    let result: { object: any; usage: TokenUsage } | undefined;\n    try {\n      result = await generateObject(generateObjectConfig);\n      costTrackingOptions.costTracking.addCall({\n        type: \"other\",\n        metadata: {\n          ...costTrackingOptions.metadata,\n          gcDetails: \"generateObject\",\n          gcModel: generateObjectConfig.model.modelId,\n        },\n        tokens: {\n          input: result.usage?.promptTokens ?? 0,\n          output: result.usage?.completionTokens ?? 0,\n        },\n        model: currentModel.modelId,\n        cost: calculateCost(\n          currentModel.modelId,\n          result.usage?.promptTokens ?? 0,\n          result.usage?.completionTokens ?? 0,\n        ),\n      });\n    } catch (error) {\n      lastError = error as Error;\n      if (\n        error.message?.includes(\"Quota exceeded\") ||\n        error.message?.includes(\"You exceeded your current quota\") ||\n        error.message?.includes(\"rate limit\")\n      ) {\n        logger.warn(\"Quota exceeded, retrying with fallback model\", {\n          error: lastError.message,\n        });\n        currentModel = retryModel;\n        try {\n          const retryConfig = {\n            ...generateObjectConfig,\n            model: currentModel,\n          };\n          result = await generateObject(retryConfig);\n          costTrackingOptions.costTracking.addCall({\n            type: \"other\",\n            metadata: {\n              ...costTrackingOptions.metadata,\n              gcDetails: \"generateObject fallback\",\n              gcModel: retryConfig.model.modelId,\n            },\n            tokens: {\n              input: result.usage?.promptTokens ?? 0,\n              output: result.usage?.completionTokens ?? 0,\n            },\n            model: currentModel.modelId,\n            cost: calculateCost(\n              currentModel.modelId,\n              result.usage?.promptTokens ?? 0,\n              result.usage?.completionTokens ?? 0,\n            ),\n          });\n        } catch (retryError) {\n          lastError = retryError as Error;\n          logger.error(\"Failed with fallback model\", {\n            originalError: lastError.message,\n            model: currentModel.modelId,\n          });\n          throw lastError;\n        }\n      } else if (NoObjectGeneratedError.isInstance(error)) {\n        console.log(\"No object generated\", error);\n        if (\n          error.text &&\n          error.text.startsWith(\"```json\") &&\n          error?.text.endsWith(\"```\")\n        ) {\n          try {\n            extract = JSON.parse(\n              error.text.slice(\"```json\".length, -\"```\".length).trim(),\n            );\n            result = {\n              object: extract,\n              usage: {\n                promptTokens: error.usage?.promptTokens ?? 0,\n                completionTokens: error.usage?.completionTokens ?? 0,\n                totalTokens: error.usage?.totalTokens ?? 0,\n              },\n            };\n          } catch (parseError) {\n            lastError = parseError as Error;\n            logger.error(\"Failed to parse JSON from error text\", {\n              error: lastError.message,\n            });\n            throw lastError;\n          }\n        } else {\n          throw lastError;\n        }\n      } else {\n        throw lastError;\n      }\n    }\n\n    extract = result?.object;\n\n    // If the users actually wants the items object, they can specify it as 'required' in the schema\n    // otherwise, we just return the items array\n    if (\n      options.schema &&\n      options.schema.type === \"array\" &&\n      !schema?.required?.includes(\"items\")\n    ) {\n      extract = extract?.items;\n    }\n\n    // Since generateObject doesn't provide token usage, we'll estimate it\n    const promptTokens = result.usage?.promptTokens ?? 0;\n    const completionTokens = result.usage?.completionTokens ?? 0;\n\n    return {\n      extract,\n      warning,\n      numTokens: promptTokens,\n      totalUsage: {\n        promptTokens,\n        completionTokens,\n        totalTokens: promptTokens + completionTokens,\n      },\n      model: currentModel.modelId,\n    };\n  } catch (error) {\n    lastError = error as Error;\n    if (error.message?.includes(\"refused\")) {\n      throw new LLMRefusalError(error.message);\n    }\n    logger.error(\"LLM extraction failed\", {\n      error: lastError,\n      model: currentModel.modelId,\n      mode,\n    });\n    throw lastError;\n  }\n}\n\nexport async function performLLMExtract(\n  meta: Meta,\n  document: Document,\n): Promise<Document> {\n  if (meta.options.formats.includes(\"extract\")) {\n    if (meta.internalOptions.zeroDataRetention) {\n      document.warning = \"JSON mode is not supported with zero data retention.\" + (document.warning ? \" \" + document.warning : \"\")\n      return document;\n    }\n\n    // const originalOptions = meta.options.extract!;\n\n    // let generationOptions = { ...originalOptions }; // Start with original options\n\n    const generationOptions: GenerateCompletionsOptions = {\n      logger: meta.logger.child({\n        method: \"performLLMExtract/generateCompletions\",\n      }),\n      options: meta.options.extract!,\n      markdown: document.markdown,\n      previousWarning: document.warning,\n      // ... existing model and provider options ...\n      // model: getModel(\"o3-mini\", \"openai\"), // Keeping existing model selection\n      // model: getModel(\"o3-mini\", \"openai\"),\n      // model: getModel(\"qwen-qwq-32b\", \"groq\"),\n      // model: getModel(\"gemini-2.0-flash\", \"google\"),\n      // model: getModel(\"gemini-2.5-pro-preview-03-25\", \"vertex\"),\n      model: getModel(\"gpt-4o-mini\", \"openai\"),\n      retryModel: getModel(\"gpt-4o\", \"openai\"),\n      costTrackingOptions: {\n        costTracking: meta.costTracking,\n        metadata: {\n          module: \"scrapeURL\",\n          method: \"performLLMExtract\",\n        },\n      },\n    };\n\n    const { extractedDataArray, warning, costLimitExceededTokenUsage } =\n      await extractData({\n        extractOptions: generationOptions,\n        urls: [meta.rewrittenUrl ?? meta.url],\n        useAgent: false,\n        scrapeId: meta.id,\n      });\n\n    if (warning) {\n      document.warning = warning + (document.warning ? \" \" + document.warning : \"\");\n    }\n\n    // IMPORTANT: here it only get's the last page!!!\n    const extractedData =\n      extractedDataArray[extractedDataArray.length - 1] ?? undefined;\n\n    // // Prepare the schema, potentially wrapping it\n    // const { schemaToUse, schemaWasWrapped } = prepareSmartScrapeSchema(\n    //   originalOptions.schema,\n    //   meta.logger,\n    // );\n\n    // // Update generationOptions with the potentially wrapped schema\n    // generationOptions.schema = schemaToUse;\n\n    // meta.internalOptions.abort?.throwIfAborted();\n    // const {\n    //   extract: rawExtract,\n    //   warning,\n    //   totalUsage,\n    //   model,\n    // } = await generateCompletions({\n    //   logger: meta.logger.child({\n    //     method: \"performLLMExtract/generateCompletions\",\n    //   }),\n    //   options: generationOptions, // Use the potentially modified options\n    //   markdown: document.markdown,\n    //   previousWarning: document.warning,\n    //   // ... existing model and provider options ...\n    //   model: getModel(\"o3-mini\", \"openai\"), // Keeping existing model selection\n    //   providerOptions: {\n    //     anthropic: {\n    //       thinking: { type: \"enabled\", budgetTokens: 12000 },\n    //     },\n    //   },\n    // });\n\n    // // Log token usage\n    // meta.logger.info(\"LLM extraction token usage\", {\n    //   model: model,\n    //   promptTokens: totalUsage.promptTokens,\n    //   completionTokens: totalUsage.completionTokens,\n    //   totalTokens: totalUsage.totalTokens,\n    // });\n\n    // // Process the result to extract data and SmartScrape decision\n    // const {\n    //   extractedData,\n    //   shouldUseSmartscrape,\n    //   smartscrape_reasoning,\n    //   smartscrape_prompt,\n    // } = processSmartScrapeResult(rawExtract, schemaWasWrapped, meta.logger);\n\n    // // Log the SmartScrape decision if applicable\n    // if (schemaWasWrapped) {\n    //   meta.logger.info(\"SmartScrape decision processing result\", {\n    //     shouldUseSmartscrape,\n    //     smartscrape_reasoning,\n    //     // Don't log the full prompt potentially\n    //     smartscrape_prompt_present: !!smartscrape_prompt,\n    //     extractedDataIsPresent:\n    //       extractedData !== undefined && extractedData !== null,\n    //   });\n\n    //   // TODO: Implement logic to ACTUALLY trigger SmartScrape based on the result\n    //   // For example:\n    //   // if (shouldUseSmartscrape && smartscrape_prompt) {\n    //   //   meta.logger.info(\"Triggering SmartScrape refinement...\", { reason: smartscrape_reasoning, prompt: smartscrape_prompt });\n    //   //   // Call the smartScrape function (which needs to be implemented/imported)\n    //   //   // const smartScrapedDocs = await smartScrape(meta.rewrittenUrl ?? meta.url, smartscrape_prompt);\n    //   //   // Process/merge smartScrapedDocs with extractedData\n    //   //   // ... potentially update finalExtract ...\n    //   // } else {\n    //   //   meta.logger.info(\"SmartScrape not required based on LLM output.\");\n    //   // }\n    // }\n\n    // Assign the final extracted data\n    if (meta.options.formats.includes(\"json\")) {\n      document.json = extractedData;\n    } else {\n      document.extract = extractedData;\n    }\n    // document.warning = warning;\n  }\n\n  return document;\n}\n\nexport function removeDefaultProperty(schema: any): any {\n  if (typeof schema !== \"object\" || schema === null) return schema;\n\n  const rest = { ...schema };\n\n  // unsupported global keys\n  delete rest.default;\n\n  // unsupported object keys\n  delete rest.patternProperties;\n  delete rest.unevaluatedProperties;\n  delete rest.propertyNames;\n  delete rest.minProperties;\n  delete rest.maxProperties;\n\n  // unsupported string keys\n  delete rest.minLength;\n  delete rest.maxLength;\n  delete rest.pattern;\n  delete rest.format;\n\n  // unsupported number keys\n  delete rest.minimum;\n  delete rest.maximum;\n  delete rest.multipleOf;\n\n  // unsupported array keys\n  delete rest.unevaluatedItems;\n  delete rest.contains;\n  delete rest.minContains;\n  delete rest.maxContains;\n  delete rest.minItems;\n  delete rest.maxItems;\n  delete rest.uniqueItems;\n\n  for (const key in rest) {\n    if (Array.isArray(rest[key])) {\n      rest[key] = rest[key].map((item: any) => removeDefaultProperty(item));\n    } else if (typeof rest[key] === \"object\" && rest[key] !== null) {\n      rest[key] = removeDefaultProperty(rest[key]);\n    }\n  }\n\n  return rest;\n}\n\nexport async function generateSchemaFromPrompt(\n  prompt: string,\n  logger: Logger,\n  costTracking: CostTracking,\n): Promise<{ extract: any }> {\n  const model = getModel(\"gpt-4o\", \"openai\");\n  const retryModel = getModel(\"gpt-4o-mini\", \"openai\");\n  const temperatures = [0, 0.1, 0.3]; // Different temperatures to try\n  let lastError: Error | null = null;\n\n  for (const temp of temperatures) {\n    try {\n      const { extract } = await generateCompletions({\n        logger: logger.child({\n          method: \"generateSchemaFromPrompt/generateCompletions\",\n        }),\n        model,\n        retryModel,\n        markdown: \"\",\n        options: {\n          mode: \"llm\",\n          systemPrompt: `You are a schema generator for a web scraping system. Generate a JSON schema based on the user's prompt.\nConsider:\n1. The type of data being requested\n2. Required fields vs optional fields\n3. Appropriate data types for each field\n4. Nested objects and arrays where appropriate\n\nValid JSON schema, has to be simple. No crazy properties. OpenAI has to support it.\nSupported types\nThe following types are supported for Structured Outputs:\n\nString\nNumber\nBoolean\nInteger\nObject\nArray\nEnum\nanyOf\n\nFormats are not supported. Min/max are not supported. Anything beyond the above is not supported. Keep it simple with types and descriptions.\nOptionals are not supported.\nDO NOT USE FORMATS.\nKeep it simple. Don't create too many properties, just the ones that are needed. Don't invent properties.\nReturn a valid JSON schema object with properties that would capture the information requested in the prompt.`,\n          prompt: `Generate a JSON schema for extracting the following information: ${prompt}`,\n          // temperature: temp,\n        },\n        costTrackingOptions: {\n          costTracking,\n          metadata: {\n            module: \"scrapeURL\",\n            method: \"generateSchemaFromPrompt\",\n          },\n        },\n      });\n\n      return { extract };\n    } catch (error) {\n      lastError = error as Error;\n      logger.warn(`Failed attempt with temperature ${temp}: ${error.message}`);\n      continue;\n    }\n  }\n\n  // If we get here, all attempts failed\n  throw new Error(\n    `Failed to generate schema after all attempts. Last error: ${lastError?.message}`,\n  );\n}\n"]}